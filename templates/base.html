<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>PDF Text Reading App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <main>
        {% include 'header.html' %}
        {% block content %}{% endblock %}
        {% include 'sidebar.html' %}
    </main>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        const signInBtn = document.getElementById('sign-in');
        if (signInBtn) {
            signInBtn.addEventListener('click', async () => {
                try {
                    const res = await puter.auth.signIn();
                    console.log('Auth response:', res);
                    await fetch('/puter-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: res.username,
                            token: res.token
                        }),
                    });
                    location.reload();
                } catch (err) {
                    console.error('Sign-in failed:', err);
                }
            });
        }

        const signOutBtn = document.getElementById('sign-out');
        if (signOutBtn) {
            signOutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    // 1. Sign out from Puter
                    await puter.auth.signOut();
                    // 2. Clear Flask session
                    await fetch('/puter-logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                    // 3. Redirect
                    window.location.href = "/";
                } catch (err) {
                    console.error('Sign-out failed:', err);
                }
            });
        }

        // selecting male/female voice based on language
        const voicesByLanguage = {
            "en-GB": [
                { value: "Brian", label: "Male" },
                { value: "Amy", label: "Female" }
            ],
            "en-US": [
                { value: "Justin", label: "Male" },
                { value: "Joanna", label: "Female" }
            ],
            "ja-JP": [
                { value: "Takumi", label: "Male" },
                { value: "Mizuki", label: "Female" }
            ]
        };
        // get user inputs for language and voice
        const languageSelect = document.getElementById("language-select");
        const voiceSelect = document.getElementById("voice-select");

        function updateVoices(language) {
            voiceSelect.innerHTML = "";

            voicesByLanguage[language].forEach(voice => {
                const option = document.createElement("option");
                option.value = voice.value;
                option.textContent = voice.label;
                voiceSelect.appendChild(option);
            });
        }

        updateVoices(languageSelect.value);

        languageSelect.addEventListener("change", (e) => {
            updateVoices(e.target.value);
        });

        // play the text with language/voice selected
        let audio = null;

        // DOM references
        const playButton = document.getElementById('play-button');
        const pauseButton = document.getElementById('pause-button');
        const stopButton = document.getElementById('stop-button');

        const textOutput = document.getElementById('text-output');

        async function playText() {
            const text = textOutput.textContent.trim();
            if (!text) return;

            // Resume if paused
            if (audio && audio.paused) {
                audio.play();
                return;
            }

            // Restart if already playing
            if (audio && !audio.paused) {
                audio.currentTime = 0;
                return;
            }

            // Generate new audio
            try {
                audio = await puter.ai.txt2speech(text, {
                    language: languageSelect.value,
                    voice: voiceSelect.value,
                });

                audio.onended = () => {
                    audio = null;
                };

                audio.play();
            } catch (err) {
                console.error('TTS error:', err);
            }
        }

        function pauseText() {
            if (audio && !audio.paused) {
                audio.pause();
            }
        }

        function stopText() {
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio = null;
            }
        }

        // Button bindings
        playButton.addEventListener('click', playText);
        pauseButton.addEventListener('click', pauseText);
        stopButton.addEventListener('click', stopText);


    </script>

</body>
</html>